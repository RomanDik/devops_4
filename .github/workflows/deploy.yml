name: CD Docker Compose

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy Docker Compose stack
      run: |
        ssh -o StrictHostKeyChecking=no -p 2425 vboxuser@course.prafdin.ru 'bash -s' << 'EOF'
        set -e
        
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        # Останавливаем старые контейнеры
        docker stop $(docker ps --filter "publish=8181" -q) 2>/dev/null || true
        docker rm $(docker ps -a --filter "publish=8181" -q) 2>/dev/null || true
        
        cd /home/vboxuser/devops-app-4
        
        # Создаем docker-compose.yml
        cat > docker-compose.yml << 'COMPOSE'
        version: '3.8'
        services:
          app:
            image: ghcr.io/romandik/devops_4:latest
            ports:
              - "8181:8181"
            depends_on:
              db:
                condition: service_healthy
            environment:
              - DATABASE_HOST=db
              - DATABASE_PORT=5432
              - DATABASE_NAME=devopsdb
              - DATABASE_USER=devopsuser
              - DATABASE_PASSWORD=devopspass
              - DEPLOY_TIME=\$(date '+%Y-%m-%d %H:%M:%S')
            restart: unless-stopped
            networks:
              - devops-network
          db:
            image: postgres:15-alpine
            environment:
              - POSTGRES_DB=devopsdb
              - POSTGRES_USER=devopsuser
              - POSTGRES_PASSWORD=devopspass
            volumes:
              - postgres_data:/var/lib/postgresql/data
            healthcheck:
              test: ["CMD-SHELL", "pg_isready -U devopsuser -d devopsdb"]
              interval: 10s
              timeout: 5s
              retries: 5
            restart: unless-stopped
            networks:
              - devops-network
        volumes:
          postgres_data:
        networks:
          devops-network:
            driver: bridge
        COMPOSE
        
        # ПУЛИМ ОБРАЗ - теперь будет работать после логина
        docker pull ghcr.io/romandik/devops_4:latest
        
        docker-compose down --remove-orphans 2>/dev/null || true
        docker-compose up -d
        
        sleep 20
        echo "=== Checking deployment ==="
        if curl -s -f http://localhost:8181 > /dev/null; then
          echo "Deployment successful!"
        else
          echo "Deployment failed"
          docker-compose logs
          exit 1
        fi
        EOF