name: CD Docker Compose

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy Docker Compose stack
      run: |
        ssh -o StrictHostKeyChecking=no -p 2425 vboxuser@course.prafdin.ru 'bash -s' << 'EOF'
        set -e  # Выходим при ошибке
        
        # 1. Останавливаем всё на порту 8181 (старая лаба №3)
        docker stop $(docker ps --filter "publish=8181" -q) 2>/dev/null || true
        docker rm $(docker ps -a --filter "publish=8181" -q) 2>/dev/null || true
        
        # 2. Переходим в папку
        mkdir -p /home/vboxuser/devops-app-4
        cd /home/vboxuser/devops-app-4
        
        # 3. Создаем docker-compose.yml БЕЗ PGADMIN
        cat > docker-compose.yml << 'COMPOSE'
        version: '3.8'
        
        services:
          app:
            image: ghcr.io/romandik/devops_4:${{ github.sha }}
            ports:
              - "8181:8181"
            depends_on:
              db:
                condition: service_healthy
            environment:
              - DATABASE_HOST=db
              - DATABASE_PORT=5432
              - DATABASE_NAME=devopsdb
              - DATABASE_USER=devopsuser
              - DATABASE_PASSWORD=devopspass
              - DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
            restart: unless-stopped
            networks:
              - devops-network
        
          db:
            image: postgres:15-alpine
            environment:
              - POSTGRES_DB=devopsdb
              - POSTGRES_USER=devopsuser
              - POSTGRES_PASSWORD=devopspass
            volumes:
              - postgres_data:/var/lib/postgresql/data
            healthcheck:
              test: ["CMD-SHELL", "pg_isready -U devopsuser -d devopsdb"]
              interval: 10s
              timeout: 5s
              retries: 5
            restart: unless-stopped
            networks:
              - devops-network
        
        volumes:
          postgres_data:
        
        networks:
          devops-network:
            driver: bridge
        COMPOSE
        
        # 4. Логинимся в GHCR (если нужно)
        # echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        # 5. Останавливаем старый стек
        docker-compose down --remove-orphans 2>/dev/null || true
        
        # 6. Запускаем новый стек
        echo "Starting Docker Compose stack..."
        docker-compose up -d
        
        # 7. Ждём готовности БД
        echo "Waiting for PostgreSQL to be healthy..."
        sleep 20
        
        # 8. Проверяем
        echo "=== Containers status ==="
        docker-compose ps
        
        echo "=== Checking application ==="
        if curl -s -f --retry 3 --retry-delay 5 http://localhost:8181 > /dev/null; then
          echo "Docker Compose stack deployed successfully!"
          echo "App URL: http://app.dik.course.prafdin.ru:8181"
          echo "PostgreSQL is running with persistent volume"
          exit 0
        else
          echo "Application failed to start"
          echo "=== Application logs ==="
          docker-compose logs app
          echo "=== Database logs ==="
          docker-compose logs db
          exit 1
        fi
        EOF